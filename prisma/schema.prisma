// Prisma schema generated from existing Drizzle models
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TransactionType {
  EXPENSE
  INCOME
  TRANSFER
}

enum CategoryType {
  EXPENSE
  INCOME
}



enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum DateFormat {
  MDY
  DMY
  YMD
}

enum AccountType {
  CASH
  SAVINGS
  INVESTMENT
  CREDIT
  OTHER
}

enum ReportPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

enum HouseholdRole {
  OWNER
  MEMBER
}

model User {
  id            String         @id @default(uuid()) @db.Uuid
  clerkId       String         @unique @db.VarChar(255)
  email         String         @unique @db.VarChar(255)
  firstName     String?        @db.VarChar(255)
  lastName      String?        @db.VarChar(255)
  imageUrl      String?
  onboarded     Boolean        @default(false)
  onboardingStep Int?
  createdAt     DateTime       @default(now()) @db.Timestamp(6)
  updatedAt     DateTime       @default(now()) @db.Timestamp(6)

  conversations  Conversation[]

  // Budgeting relations
  preference    UserPreference?
  householdMembers HouseholdMember[]
  transactionsCreated Transaction[] @relation("CreatedBy")
}

model Household {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(255)
  seatLimit       Int      @default(1)
  stripeCustomerId String?  @db.VarChar(255)
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @db.Timestamp(6)

  members         HouseholdMember[]
  subscriptions   Subscription[]
  accounts        Account[]
  categories      Category[]
  budgets         Budget[]
  budgetDefinitions BudgetDefinition[]
  reports         Report[]
  transactions    Transaction[]

  @@index([seatLimit])
}

model HouseholdMember {
  id          String        @id @default(uuid()) @db.Uuid
  householdId String        @db.Uuid
  userId      String        @db.Uuid
  role        HouseholdRole @default(MEMBER)
  invitedAt   DateTime?     @db.Timestamp(6)
  joinedAt    DateTime?     @db.Timestamp(6)

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
  @@index([userId])
  @@index([householdId])
}

model Subscription {
  id                     String   @id @default(uuid()) @db.Uuid
  householdId            String   @db.Uuid
  stripeCustomerId       String   @db.VarChar(255)
  stripeSubscriptionId   String   @db.VarChar(255)
  stripePriceId          String   @db.VarChar(255)
  stripeCurrentPeriodEnd DateTime @db.Timestamp(6)
  status                 String   @db.VarChar(50)
  plan                   String   @db.VarChar(50)
  createdAt              DateTime @default(now()) @db.Timestamp(6)
  updatedAt              DateTime @default(now()) @db.Timestamp(6)

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId])
  @@index([stripeSubscriptionId])
}

model Conversation {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  title     String    @db.VarChar(255)
  createdAt DateTime  @default(now()) @db.Timestamp(6)
  updatedAt DateTime  @default(now()) @db.Timestamp(6)

  user     User      @relation(fields: [userId], references: [id])
  messages Message[]

  @@index([userId])
}

model Message {
  id             String    @id @default(uuid()) @db.Uuid
  conversationId String    @db.Uuid
  role           String    @db.VarChar(50)
  content        String
  metadata       Json?
  createdAt      DateTime  @default(now()) @db.Timestamp(6)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model Category {
  id          String       @id @default(uuid()) @db.Uuid
  householdId String       @db.Uuid
  name        String       @db.VarChar(100)
  type        CategoryType
  color       String?      @db.VarChar(16)
  icon        String?      @db.VarChar(64)
  createdAt   DateTime     @default(now()) @db.Timestamp(6)
  updatedAt   DateTime     @default(now()) @db.Timestamp(6)

  household         Household         @relation(fields: [householdId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  budgets           Budget[]
  budgetDefinitions BudgetDefinition[]

  @@unique([householdId, name, type])
  @@index([householdId])
  @@index([type])
}

model Account {
  id             String   @id @default(uuid()) @db.Uuid
  householdId    String   @db.Uuid
  name           String   @db.VarChar(255)
  type           AccountType
  currencyCode   String   @default("EUR") @db.VarChar(3)
  initialBalance Decimal  @default(0) @db.Decimal(18, 2)
  createdAt      DateTime @default(now()) @db.Timestamp(6)
  updatedAt      DateTime @default(now()) @db.Timestamp(6)

  household         Household         @relation(fields: [householdId], references: [id], onDelete: Cascade)
  transactionsFrom  Transaction[]     @relation("TxnFrom")
  transactionsTo    Transaction[]     @relation("TxnTo")

  @@index([householdId])
  @@index([type])
}

model Transaction {
  id              String          @id @default(uuid()) @db.Uuid
  householdId     String          @db.Uuid
  createdByUserId String          @db.Uuid
  fromAccountId   String?         @db.Uuid
  toAccountId     String?         @db.Uuid
  categoryId      String?         @db.Uuid
  type            TransactionType
  amount          Decimal         @db.Decimal(18, 2)
  occurredAt      DateTime
  description     String?         @db.VarChar(255)
  note            String?
  reviewed        Boolean          @default(true)
  possibleDuplicate Boolean        @default(false)
  duplicateOfTransactionId String? @db.Uuid
  createdAt       DateTime        @default(now()) @db.Timestamp(6)
  updatedAt       DateTime        @default(now()) @db.Timestamp(6)

  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  createdBy   User      @relation("CreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  fromAccount Account?  @relation("TxnFrom", fields: [fromAccountId], references: [id], onDelete: SetNull)
  toAccount   Account?  @relation("TxnTo", fields: [toAccountId], references: [id], onDelete: SetNull)
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  duplicateOf Transaction? @relation("TransactionDuplicates", fields: [duplicateOfTransactionId], references: [id], onDelete: SetNull)
  duplicates  Transaction[] @relation("TransactionDuplicates")

  @@index([householdId, occurredAt])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([categoryId])
  @@index([type])
  @@index([createdByUserId])
  @@index([duplicateOfTransactionId])
}

model Budget {
  id           String         @id @default(uuid()) @db.Uuid
  householdId  String         @db.Uuid
  categoryId   String         @db.Uuid
  definitionId String?        @db.Uuid
  name         String         @db.VarChar(255)
  startDate    DateTime       @db.Date
  endDate      DateTime       @db.Date
  amount       Decimal        @db.Decimal(18, 2)
  createdAt    DateTime       @default(now()) @db.Timestamp(6)
  updatedAt    DateTime       @default(now()) @db.Timestamp(6)

  household  Household        @relation(fields: [householdId], references: [id], onDelete: Cascade)
  category   Category         @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  definition BudgetDefinition? @relation(fields: [definitionId], references: [id], onDelete: SetNull)

  @@unique([householdId, categoryId, startDate, endDate])
  @@index([householdId])
  @@index([categoryId])
  @@index([startDate, endDate])
  @@index([definitionId])
}

model BudgetDefinition {
  id          String       @id @default(uuid()) @db.Uuid
  householdId String       @db.Uuid
  categoryId  String       @db.Uuid
  name        String       @db.VarChar(255)
  amount      Decimal      @db.Decimal(18, 2)
  isActive    Boolean      @default(true)
  startDate   DateTime     @db.Date
  createdAt   DateTime     @default(now()) @db.Timestamp(6)
  updatedAt   DateTime     @default(now()) @db.Timestamp(6)
  archivedAt  DateTime?    @db.Timestamp(6)

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  budgets   Budget[]

  @@unique([householdId, categoryId])
  @@index([householdId])
  @@index([categoryId])
  @@index([isActive])
}

model UserPreference {
  id                       String            @id @default(uuid()) @db.Uuid
  userId                   String            @unique @db.Uuid
  defaultCurrencyCode      String            @db.VarChar(3)
  theme                    Theme             @default(DARK)
  dateFormat               DateFormat        @default(MDY)
  budgetStartDay           Int               @default(1) // Day of month (1-31) when budgets start
  budgetAlerts             Boolean           @default(true)
  transactionNotifications Boolean           @default(true)
  monthlyReports           Boolean           @default(true)
  emailNotifications       Boolean           @default(false)
  createdAt                DateTime          @default(now()) @db.Timestamp(6)
  updatedAt                DateTime          @default(now()) @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Report {
  id               String       @id @default(uuid()) @db.Uuid
  householdId      String       @db.Uuid
  period           ReportPeriod
  startDate        DateTime     @db.Date
  endDate          DateTime     @db.Date
  status           ReportStatus @default(PENDING)
  isInitial        Boolean      @default(false)
  // Unified, versioned payload for UI + LLM outputs + suggestions
  data             Json?
  
  // Metadata
  transactionCount Int          @default(0)
  generatedAt      DateTime?    @db.Timestamp(6)
  createdAt        DateTime     @default(now()) @db.Timestamp(6)
  updatedAt        DateTime     @default(now()) @db.Timestamp(6)

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([householdId, period, startDate, endDate])
  @@index([householdId, startDate, endDate])
  @@index([status])
  @@index([period])
  @@index([isInitial])
}

